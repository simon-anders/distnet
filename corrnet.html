<!DOCTYPE html>
<meta charset="utf-8">

<title>distmat display</title>

<style>

#mypanel circle {
   fill: orange;
   fill-opacity: .9;
}
</style>

<svg id="mypanel" class="chart" width="600" height="600">
</svg>


<table width="600px" style="border-spacing:25px">
<tr><td><div id="slider_midpoint" style="width:550px"></div></td></tr>
<tr><td><div id="slider_slope" style="width:550px"></div></td></tr>
</table>

<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

<link rel="stylesheet" href="https://rawgit.com/MasterMaps/d3-slider/master/d3.slider.css"></link>
<script src="https://rawgit.com/MasterMaps/d3-slider/master/d3.slider.js"></script>

<script>
// taken from http://stackoverflow.com/questions/4116992/how-to-include-json-data-in-javascript-synchronously-without-parsing
function loadTextFileAjaxSync( filePath )
{
  var xmlhttp = new XMLHttpRequest()
  xmlhttp.open( "GET", filePath, false )
  xmlhttp.send()
  return xmlhttp.responseText
}
</script>


<script>

var inputdata = JSON.parse( loadTextFileAjaxSync( "points.json" ) )

function blowup( x ) { return Math.min( Math.max( 300 * ( x + 1 ), 0 ), 600 ) }

var pointspos = inputdata.conf.map( 
   function( a ) { return { x: blowup(a[0]), y: blowup(a[1]) } } )

function sigmoid( x, midpoint, slope ) {
   return 1 / ( 1 + Math.exp( -slope * ( x - midpoint ) ) )
}


var slider_midpoint = d3.slider()
      .axis( true )
      .max( 2 )
      .value( .1 )
      .on( "slide", update )
d3.select('#slider_midpoint').call( slider_midpoint )

var slider_slope = d3.slider()
      .axis( true )
      .max( 200 )
      .value( 20 )
      .on( "slide", update )
d3.select('#slider_slope').call( slider_slope )      


var distslist = []
for( i = 0; i < inputdata.dm.length; i++ )
   for( j = i+1; j < inputdata.dm.length; j++ )
      distslist.push( { p1: i, p2: j, dist: inputdata.dm[i][j] })

console.log( pointspos )

function update() {

   // lines:

   mysigmoid = function( x ) { return sigmoid( x, slider_midpoint.value(), -slider_slope.value() ) } 

   var shortdistslist = distslist.filter( 
      function(a) { return mysigmoid( a.dist ) > .2 } )

   var selection = d3.select("#mypanel").selectAll("line")
      .data( shortdistslist )
   selection.enter().append("line")
   selection.exit().remove()
   selection
      .attr( "x1", function(d) { return pointspos[d.p1].x } )
      .attr( "y1", function(d) { return pointspos[d.p1].y } )
      .attr( "x2", function(d) { return pointspos[d.p2].x } )
      .attr( "y2", function(d) { return pointspos[d.p2].y } )
      .attr( "style", function(d) { 
         alpha = mysigmoid( d.dist )
         return "stroke: rgb(255,0,0); stroke-width: 1.5; stroke-opacity: " + alpha } )

   // points:

   var drag = d3.behavior.drag()
       .on( "drag", function( d, i ) {
            d.x += d3.event.dx
            d.y += d3.event.dy
            update()
        })
  
   selection = d3.select("#mypanel").selectAll("circle")
      .data( pointspos )
   selection.enter().append("circle")
      .attr( "r", 9 )
      .call( drag )
   selection
      .attr( "cx", function(d) { return d.x } )
      .attr( "cy", function(d) { return d.y } )

}

update()

</script>