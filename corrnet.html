<!DOCTYPE html>
<meta charset="utf-8">

<title>movable points</title>

<style>

.mylistclass li {
  color: blue;
}

.chart circle {
   fill: orange;
}
</style>

<svg id="mypanel" class="chart" width="600" height="600">
</svg>

<ul id="mylist" class="mylistclass">
</ul>


<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

<script>
// taken from http://stackoverflow.com/questions/4116992/how-to-include-json-data-in-javascript-synchronously-without-parsing
function loadTextFileAjaxSync( filePath )
{
  var xmlhttp = new XMLHttpRequest()
  xmlhttp.open( "GET", filePath, false )
  xmlhttp.send()
  return xmlhttp.responseText
}
</script>


<script>

var inputdata = JSON.parse( loadTextFileAjaxSync( "points.json" ) )

console.log( inputdata.conf )

function blowup( x ) { return Math.min( Math.max( 300 * ( x + 1 ), 0 ), 600 ) }

var pointspos = inputdata.conf.map( 
   function( a ) { return { x: blowup(a[0]), y: blowup(a[1]) } } )

function sigmoid( x, midpoint, slope ) {
   return 1 / ( 1 + Math.exp( -slope * ( x - midpoint ) ) )
}


var distslist = []
for( i = 0; i < inputdata.dm.length; i++ )
   for( j = i+1; j < inputdata.dm.length; j++ )
      distslist.push( { p1: i, p2: j, dist: inputdata.dm[i][j] })

console.log( pointspos )

function update() {

   var drag = d3.behavior.drag()
       .on( "drag", function( d, i ) {
            d.x += d3.event.dx
            d.y += d3.event.dy
            update()
        })
  
   var selection = d3.select("#mypanel").selectAll("circle")
      .data( pointspos )
   selection.enter().append("circle")
      .attr( "r", 9 )
      .call( drag )
   selection
      .attr( "cx", function(d) { return d.x } )
      .attr( "cy", function(d) { return d.y } )


   selection = d3.select("#mylist").selectAll("li")
      .data( pointspos )
   selection.enter().append("li")
   selection
      .text( function(d) { return d.x + " / " + d.y } )


   var shortdistslist = distslist.filter( function(a) { return a.dist < .2 } )

   selection = d3.select("#mypanel").selectAll("line")
      .data( shortdistslist )
   selection.enter().append("line")
   selection
      .attr( "x1", function(d) { return pointspos[d.p1].x } )
      .attr( "y1", function(d) { return pointspos[d.p1].y } )
      .attr( "x2", function(d) { return pointspos[d.p2].x } )
      .attr( "y2", function(d) { return pointspos[d.p2].y } )
      .attr( "style", function(d) { 
         alpha = sigmoid( d.dist, .1, -20 )
         return "stroke: rgb(255,0,0); stroke-width: 1.5; stroke-opacity: " + alpha } )



}

update()

</script>